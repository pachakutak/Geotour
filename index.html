<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Карта Telegram</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
	
  <!-- Leaflet CSS -->
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style> #map { width:100%; height:100vh; } </style>
</head>
<body>
<div id="map"></div>
  <script src="/static/hexgrid.js"></script>
  <script>
    // инициализация карты
    const map = L.map('map').fitWorld();
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    // получить уже открытые гексагоны
    let opened = [];
    fetch('/user_hexes')
      .then(r => r.json())
      .then(data => opened = data);

    // инициализируем слой с гексагонами
    const hexLayer = L.layerGroup().addTo(map);

    function drawHexGrid() {
      hexLayer.clearLayers();
      const bounds = map.getBounds();
      // hexgrid.js содержит функцию generateHexGrid(bounds, radius)
      const hexes = generateHexGrid(bounds, 100);
      hexes.forEach(h => {
        const isOpened = opened.some(o =>
          Math.abs(o.lat - h.center.lat)<1e-6 && Math.abs(o.lng - h.center.lng)<1e-6);
        L.polygon(h.points, {
          opacity: isOpened ? 0 : 0.8,
          color: '#000000',
        }).addTo(hexLayer).hexCenter = h.center;
      });
    }

    map.on('moveend zoomend', drawHexGrid);
    map.locate({setView: true, watch: true});

    map.on('locationfound', e => {
      // найдём гексагон, в который вошли
      hexLayer.eachLayer(layer => {
        if (layer.getBounds().contains(e.latlng) && layer.options.opacity > 0.01) {
          const {lat,lng} = layer.hexCenter;
          // сообщаем бэкенду
          fetch('/hex_toggle', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({lat,lng})
          });
          layer.setStyle({opacity: 0});
        }
      });
    });

    // первый раз отрисуем
    drawHexGrid();
<script src="script.js"></script>
  </script>
</body>
</html>
